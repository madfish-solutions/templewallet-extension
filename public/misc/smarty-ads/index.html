<!--
  This page is not to be packaged with extension, but hosted remotely. (i.e. @ https://templewallet.com/smarty-ads)
  Serve locally by:
  ```bash
  yarn global add http-server
  yarn serve-smarty-ads
  ```
-->

<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="utf-8" />
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" /> -->
  <title>Temple Wallet | Smarty ads</title>

  <!-- SCRIPTS -->

  <!-- <script src="./index.js"></script> -->

  <style>
    body {
      margin: 0;
    }

    #ad-slot {
      display: contents;
    }
  </style>
</head>

<body>
  <div id="ad-slot">
    <!-- Place for ad to be inserted into -->
  </div>

  <script>
    const usp = new URLSearchParams(window.location.search);
    const placementId = usp.get('placementId');
    const width = usp.get('width');
    const height = usp.get('height');

    async function fetchAdHtml(placementId, width, height) {
      const resType = 'json'; // Mandatory, despite what the manual says
      const gdpr_consent = 'BOSSotLOSSotLAPABAENBc-AAAAgR7_______9______9uz_Gv_v_f__33e8__9v_l_7_-___u_-33d4-_1vX99yfm1-7ftr3t';
      const gpp = 'DBACNYA~CPXxRfAPXxRfAAfKABENB-CgAAAAAAAAAAYgAAAAAAAA~1YNN';

      // `ad_width` & `ad_height` params have no effect
      const response = await fetch(
        `https://n1.smartyads.com/?c=b&m=api&res=${resType}&gdpr=1&gdpr_consent=${gdpr_consent}&gpp=${gpp}&gpp_sid=2&us_privacy=1YNN&coppa=0&page=1&placementId=${placementId}&domain=templewallet.com&ua=${encodeURIComponent(navigator.userAgent)}&lmt=0&dnt=0&ad_width=${1}&ad_height=${1}`
      );

      const data /* :{
        placementId: number;
        adm: string; // Contains div, a, img + Refreshing scripts.
        width: number;
        height: number;
        deal: '';
      } */ = response.status === 204 ? null : await response.json();

      console.log('SmartyAds data:', data);

      return data?.adm;
    }

    fetchAdHtml(placementId, width, height).then(data => {
      if (!data) return void console.error('SmartyAds returned no ad');

      document.getElementById('ad-slot').innerHTML = data;

      /* In prod there might be a different condition */
      if (data.includes('/image/tst/')) console.warn('SmartyAds returned self-ad');
    }, error => {
      console.error('SmartyAds failed to respond:', error);
    })
  </script>
</body>

</html>
